#!/bin/bash

# links files from DOTS to their provided LINK

GITURL=https://github.com/Biggybi/dotfiles
SRC=$HOME/dotfiles
DST=$HOME
BACKUP=$HOME/dotfiles/dots_back

cd $SRC

# git files to link
DOTS=(vim
	vimrc
	bashrc
	bash_aliases
	inputrc
	tmux.conf
	bin
	git_template
	fonts
	zhsrc)

# links to create localy for Linux
LINK=(.vim
	.vimrc
	.bashrc
	.bash_aliases
	.inputrc
	.tmux.conf
	bin
	.git_template
	.fonts
	.zshrc)

# links to create localy for Mac
if [[ "$OSTYPE" == "darwin"* ]]
then
	LINK=(vim
		.vimrc
		.bashrc
		.bash_aliases
		.inputrc
		bin
		.git_template
		.fonts
		.zshrc)
fi

if [ -d "$SRC" ]
then
	echo "Not cloning : $SRC exists"
else
	git clone $GITURL $SRC
fi

if [ "$1" == "--git" ] || [ "$1" == "-g" ] || [ "$1" == "--plugins" ]
then
	echo "Cloning plugins"
	cd "${LINK[0]}"
	git submodule init
	git submodule update
else
	echo "Plugins already installed"
fi

i=0
# while [ -d "$BACKUP" ] && [ ! -f "$BACKUP/.dots_back" ]
# do
# 	let i=i+1
# 	echo "$BACKUP exists, new backup dir"
# 	BACKUP="$BACKUP$i"
# 	echo "$BACKUP new backup dir"
# done

# [ ! -d "$BACKUP" ] && mkdir "$BACKUP"
# [ -d "$BACKUP" ] && touch "$BACKUP/.dots_back"
# mv "$DST/$l" "$BACKUP/$l"

i=0
for f in "${DOTS[@]}"
do
	l="${LINK[i]}"
	echo "$i $l"
	cmp -s "$SRC/$f" "$DST/$l"
	if [ $? -eq 1 ] && [ -n "$l" ] && [ -e "$DST/$l" ]
	then
		echo "go backup"
		lback=$l
		if [ -e "$BACKUP/$l" ] && [ -n "$l" ]
		then
			j=0
			while [ -e "$BACKUP/$lback/" ]
			do
				let j=j+1
				echo "$BACKUP/$lback exists, new backup file"
				BACKUP="$BACKUP/$lback$j"
				echo "$BACKUP/$lback$j new backup"
			done
		fi
		if [ -d $DST/$l ]
		then
			mkdir "$BACKUP/$lback"
			mv "$DST/$l/*" "$BACKUP/$lback"
		else
			mv "$DST/$l" "$BACKUP/$lback"
		fi
		echo "save '$l' to '$BACKUP/$lback'"
	fi
	if [ ! -e "$DST/$l" ]
	then
		ln -fs "$SRC/$f" "$DST/$l"
		echo "link created : $l -> $f "
	fi
	let i=i+1
done

